{"ast":null,"code":"import React,{useState,useEffect}from'react';import{ethers}from'ethers';import{provider,contract}from'../../ethers';// 确保 provider 和 contract 被正确导入\nimport axios from'axios';import'./FundProject.css';function FundProject(_ref){let{projectId}=_ref;const[amount,setAmount]=useState('');const[error,setError]=useState('');const[isSubmitting,setIsSubmitting]=useState(false);const[isFrozen,setIsFrozen]=useState(false);useEffect(()=>{if(isSubmitting){localStorage.setItem(\"funding-\".concat(projectId),true);}else{localStorage.removeItem(\"funding-\".concat(projectId));}},[isSubmitting,projectId]);useEffect(()=>{const isFrozen=localStorage.getItem(\"funding-\".concat(projectId))==='true';setIsFrozen(isFrozen);},[projectId]);const roundAmount=amount=>{return Math.round(amount*100)/100;// 四舍五入到小数点后两位\n};const fundProject=async event=>{event.preventDefault();if(parseFloat(amount)<=0||isNaN(amount)){setError('Amount must be a positive number');return;}try{setIsSubmitting(true);await provider.send(\"eth_requestAccounts\",[]);const signer=provider.getSigner();const userAddress=await signer.getAddress();const roundedAmount=roundAmount(parseFloat(amount));const amountInWei=ethers.utils.parseEther(roundedAmount.toString());// 转换为 wei 单位\nconst tx=await contract.fundProject(parseInt(projectId,10),{value:amountInWei});await tx.wait();// 更新后端数据库\ntry{const response=await axios.post('http://localhost:3001/api/projects/fund',{projectId:parseInt(projectId,10),amount:roundedAmount,// 以 eth 为单位发送四舍五入后的金额\ncontributor:userAddress});if(response.data){alert('Project funded successfully and database updated');setAmount('');}else{alert('Failed to update database');}}catch(error){console.error('Error updating database:',error.message);alert('Error updating database');}}catch(error){console.error('Error funding project:',error.message);setError('Error funding project');}finally{setIsSubmitting(false);setIsFrozen(false);}};const handleAmountChange=e=>{const value=e.target.value;if(value===''||!isNaN(value)&&parseFloat(value)>=0){setAmount(value);setError('');}else{setError('Please enter a valid amount');}};return/*#__PURE__*/React.createElement(\"div\",{className:\"fund-project-container\"},/*#__PURE__*/React.createElement(\"h2\",null,\"Fund Project\"),/*#__PURE__*/React.createElement(\"form\",{onSubmit:fundProject},/*#__PURE__*/React.createElement(\"div\",{className:\"input-group\"},/*#__PURE__*/React.createElement(\"label\",null,\"Amount (in Ether): \"),/*#__PURE__*/React.createElement(\"input\",{type:\"number\"// 确保输入类型为 number\n,step:\"0.01\"// 可选，指定最小增量\n,value:amount,onChange:handleAmountChange,className:\"fund-input\",disabled:isSubmitting||isFrozen// 在提交期间和冻结状态禁用输入框\n})),error&&/*#__PURE__*/React.createElement(\"p\",{className:\"error\"},error),/*#__PURE__*/React.createElement(\"button\",{type:\"submit\",className:\"fund-button\",disabled:isSubmitting||isFrozen},isSubmitting?'Submitting...':'Fund Project')));}export default FundProject;","map":{"version":3,"names":["React","useState","useEffect","ethers","provider","contract","axios","FundProject","_ref","projectId","amount","setAmount","error","setError","isSubmitting","setIsSubmitting","isFrozen","setIsFrozen","localStorage","setItem","concat","removeItem","getItem","roundAmount","Math","round","fundProject","event","preventDefault","parseFloat","isNaN","send","signer","getSigner","userAddress","getAddress","roundedAmount","amountInWei","utils","parseEther","toString","tx","parseInt","value","wait","response","post","contributor","data","alert","console","message","handleAmountChange","e","target","createElement","className","onSubmit","type","step","onChange","disabled"],"sources":["/Users/matrix/front-end/src/components/FundProject/FundProject.js"],"sourcesContent":["import React, { useState, useEffect } from 'react';\r\nimport { ethers } from 'ethers';\r\nimport { provider, contract } from '../../ethers'; // 确保 provider 和 contract 被正确导入\r\nimport axios from 'axios';\r\nimport './FundProject.css';\r\n\r\nfunction FundProject({ projectId }) {\r\n  const [amount, setAmount] = useState('');\r\n  const [error, setError] = useState('');\r\n  const [isSubmitting, setIsSubmitting] = useState(false);\r\n  const [isFrozen, setIsFrozen] = useState(false);\r\n\r\n  useEffect(() => {\r\n    if (isSubmitting) {\r\n      localStorage.setItem(`funding-${projectId}`, true);\r\n    } else {\r\n      localStorage.removeItem(`funding-${projectId}`);\r\n    }\r\n  }, [isSubmitting, projectId]);\r\n\r\n  useEffect(() => {\r\n    const isFrozen = localStorage.getItem(`funding-${projectId}`) === 'true';\r\n    setIsFrozen(isFrozen);\r\n  }, [projectId]);\r\n\r\n  const roundAmount = (amount) => {\r\n    return Math.round(amount * 100) / 100; // 四舍五入到小数点后两位\r\n  };\r\n\r\n  const fundProject = async (event) => {\r\n    event.preventDefault();\r\n\r\n    if (parseFloat(amount) <= 0 || isNaN(amount)) {\r\n      setError('Amount must be a positive number');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      setIsSubmitting(true);\r\n      await provider.send(\"eth_requestAccounts\", []);\r\n      const signer = provider.getSigner();\r\n      const userAddress = await signer.getAddress();\r\n\r\n      const roundedAmount = roundAmount(parseFloat(amount));\r\n      const amountInWei = ethers.utils.parseEther(roundedAmount.toString()); // 转换为 wei 单位\r\n\r\n      const tx = await contract.fundProject(parseInt(projectId, 10), { value: amountInWei });\r\n      await tx.wait();\r\n\r\n      // 更新后端数据库\r\n      try {\r\n        const response = await axios.post('http://localhost:3001/api/projects/fund', {\r\n          projectId: parseInt(projectId, 10),\r\n          amount: roundedAmount, // 以 eth 为单位发送四舍五入后的金额\r\n          contributor: userAddress\r\n        });\r\n\r\n        if (response.data) {\r\n          alert('Project funded successfully and database updated');\r\n          setAmount('');\r\n        } else {\r\n          alert('Failed to update database');\r\n        }\r\n      } catch (error) {\r\n        console.error('Error updating database:', error.message);\r\n        alert('Error updating database');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error funding project:', error.message);\r\n      setError('Error funding project');\r\n    } finally {\r\n      setIsSubmitting(false);\r\n      setIsFrozen(false);\r\n    }\r\n  };\r\n\r\n  const handleAmountChange = (e) => {\r\n    const value = e.target.value;\r\n    if (value === '' || (!isNaN(value) && parseFloat(value) >= 0)) {\r\n      setAmount(value);\r\n      setError('');\r\n    } else {\r\n      setError('Please enter a valid amount');\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"fund-project-container\">\r\n      <h2>Fund Project</h2>\r\n      <form onSubmit={fundProject}>\r\n        <div className=\"input-group\">\r\n          <label>Amount (in Ether): </label>\r\n          <input\r\n            type=\"number\" // 确保输入类型为 number\r\n            step=\"0.01\" // 可选，指定最小增量\r\n            value={amount}\r\n            onChange={handleAmountChange}\r\n            className=\"fund-input\"\r\n            disabled={isSubmitting || isFrozen} // 在提交期间和冻结状态禁用输入框\r\n          />\r\n        </div>\r\n        {error && <p className=\"error\">{error}</p>}\r\n        <button type=\"submit\" className=\"fund-button\" disabled={isSubmitting || isFrozen}>\r\n          {isSubmitting ? 'Submitting...' : 'Fund Project'}\r\n        </button>\r\n      </form>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default FundProject;\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module"}